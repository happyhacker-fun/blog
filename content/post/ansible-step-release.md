---
title: "基于ansible的渐进上线流程探究"
date: 2020-04-17T23:28:21+08:00
tags: ["ansible", "ci", "cd"]
draft: true
categories: ["in-action"]
---

继上一篇文章[Springboot使用内置和独立tomcat以及其他思考](/post/spring-tomcat-tutorial/)中描述的，继续优化整个发布流程。

<!--more-->

实际上线之后发现每次发布要改版本号还是挺麻烦的，手动改版本号还是不太适合频繁迭代的项目。要实现不改版本号且服务不中断就得重新想办法了。  
观察发现，当同一个包覆盖原有的包时，接口会报404，很显然这是tomcat正在解压新的war包，还没有准备好服务，这个过程肯定是无法优化的，只能想办法让这台机器在这期间不提供服务。还是需要nginx来做。

## 整体思路

整个思路基于接入层的LB具有健康检测功能，也就是当某台服务器的80端口不开放时，将没有请求访问到这台服务器。这是整个方案设计的基础。  

假设一共有n台机器需要发布新版本，流程如下：

![渐进上线流程图](/images/分步上线流程图.png)

不考虑使用任何现有的持续集成工具，仅用ansible实现上述流程。

## 实施过程

### 验证健康检测

Nginx的健康检查可以是主动检查或被动检查，作为反向代理（负载均衡器）的Nginx默认支持被动健康检查，这里使用默认配置来验证，后续再考虑使用openresty引入更灵活高效的主动健康检查。被动检查的问题在于是使用真实的请求作为检查的样本，即当真实请求失败多少次以后将上游服务器标记为不可用，然后会再每隔一段时间分发少量请求到已经标记为不可用的上游服务器，如果超过多少次成功后重新加入池子里。

### 关闭端口

```
iptables -A INPUT -p tcp --dport 80 -j DROP
```

### 检查是否仍有请求


